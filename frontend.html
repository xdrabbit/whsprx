<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document RAG Search</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f7f7f7;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            color: #111;
        }
        .section {
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 2rem;
        }
        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        input[type="file"], input[type="text"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        button {
            background-color: #007aff;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #005ecb;
        }
        #status, #rag-status {
            margin-top: 1rem;
            text-align: center;
            font-style: italic;
            color: #666;
        }
        #results-container, #rag-container {
            margin-top: 1.5rem;
        }
        .result-item, .context-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        .result-item p, .context-item p {
            margin: 0 0 0.5rem 0;
        }
        .result-item .meta, .context-item .meta {
            font-size: 0.85rem;
            color: #888;
        }
        #rag-answer {
            white-space: pre-wrap; /* Preserve whitespace and newlines */
            line-height: 1.6;
        }
        .attribution {
            font-size: 0.8rem;
            color: #777;
            margin-top: 1.5rem;
            text-align: right;
            border-top: 1px solid #cce4ff;
            padding-top: 1rem;
        }
        #visualize-section {
            display: none; /* Hidden by default */
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #eee;
        }
        #generated-image-container {
            margin-top: 1.5rem;
            text-align: center;
        }
        #generated-image {
            max-width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Document RAG Search</h1>

        <div class="section">
            <h2>1. Upload a Document</h2>
            <form id="upload-form">
                <label for="file-input">Select a .txt file to process:</label>
                <input id="file-input" type="file" name="file" accept=".txt">
                <button type="submit">Upload and Index</button>
            </form>
            <div id="status"></div>
        </div>

        <div class="section">
            <h2>2. Query with RAG</h2>
            <form id="rag-form">
                <label for="rag-query-input">Your Question:</label>
                <input id="rag-query-input" type="text" placeholder="e.g., What did Alice follow down the hole?">
                
                <label for="model-select">Choose an LLM:</label>
                <select id="model-select" name="model">
                    <!-- Models will be populated dynamically -->
                </select>
                
                <button type="submit">Get Answer</button>
            </form>
            <div id="rag-status"></div>
            <div id="rag-container">
                <h3>Generative Answer</h3>
                <div id="rag-answer-container">
                    <div id="rag-answer">(Your answer will appear here)</div>
                    <div id="tts-controls" style="display: none; margin-top: 1rem; align-items: center; gap: 1rem;">
                        <select id="voice-select" name="voice" style="flex-grow: 1;"></select>
                        <button id="listen-button">Listen</button>
                        <audio id="audio-player" controls style="display: none; width: 100%; margin-top: 0.5rem;"></audio>
                    </div>
                </div>
                
                <div id="visualize-section">
                    <h3>Visualize the Answer</h3>
                    <form id="visualize-form">
                        <label for="comfy-model-input">Choose an Image Model:</label>
                        <input id="comfy-model-input" list="comfy-models-list" placeholder="e.g., sd_xl_base_1.0.safetensors">
                        <datalist id="comfy-models-list">
                            <!-- ComfyUI models will be populated here -->
                        </datalist>
                        <label for="artistic-direction-input" style="margin-top: 1rem;">Artistic Direction (Optional):</label>
                        <textarea id="artistic-direction-input" rows="3" placeholder="e.g., in the style of a dark fantasy painting, cinematic lighting"></textarea>
                        <button type="submit">Generate Image</button>
                    </form>
                    <div id="visualize-status"></div>
                    <div id="generated-image-container"></div>
                </div>

                <h3>Retrieved Context</h3>
                <div id="rag-context"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Populate Ollama Models ---
        document.addEventListener('DOMContentLoaded', async () => {
            const modelSelect = document.getElementById('model-select');
            const ragStatus = document.getElementById('rag-status');
            try {
                ragStatus.textContent = 'Fetching available LLMs...';
                const response = await fetch('/api/ollama/models');
                if (!response.ok) {
                    throw new Error(`Failed to fetch models: ${response.statusText}`);
                }
                const data = await response.json();
                const models = data.models;

                if (models && models.length > 0) {
                    modelSelect.innerHTML = ''; // Clear any previous options
                    models.forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = modelName;
                        option.textContent = modelName;
                        modelSelect.appendChild(option);
                    });
                    ragStatus.textContent = 'LLMs loaded. Ready to answer questions.';
                } else {
                    ragStatus.textContent = 'No Ollama models found. Please ensure Ollama is running and has models available.';
                    modelSelect.innerHTML = '<option>No models available</option>';
                }
            } catch (error) {
                console.error('Error fetching Ollama models:', error);
                ragStatus.textContent = `Error: ${error.message}. Is Ollama running?`;
                modelSelect.innerHTML = '<option>Failed to load models</option>';
            }
        });

        // --- Handle File Upload ---
        const uploadForm = document.getElementById('upload-form');
        const statusDiv = document.getElementById('status');
        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(uploadForm);
            const fileInput = document.getElementById('file-input');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.textContent = 'Please select a file first.';
                statusDiv.style.color = 'red';
                return;
            }

            statusDiv.textContent = 'Uploading and processing...';
            statusDiv.style.color = '#333';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                if (response.ok) {
                    statusDiv.textContent = result.message;
                    statusDiv.style.color = 'green';
                } else {
                    throw new Error(result.detail || 'An unknown error occurred.');
                }
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.style.color = 'red';
            }
        });

        // --- Handle RAG Query ---
        const ragForm = document.getElementById('rag-form');
        const ragStatus = document.getElementById('rag-status');
        const ragAnswerContainer = document.getElementById('rag-answer-container');
        const ragAnswerDiv = document.getElementById('rag-answer');
        const ragContextDiv = document.getElementById('rag-context');
        const visualizeSection = document.getElementById('visualize-section');
        const ttsControls = document.getElementById('tts-controls');
        const listenButton = document.getElementById('listen-button');
        const audioPlayer = document.getElementById('audio-player');
        const voiceSelect = document.getElementById('voice-select');


        ragForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const query = document.getElementById('rag-query-input').value;
            const selectedModel = document.getElementById('model-select').value;

            if (!query) {
                ragStatus.textContent = 'Please enter a question.';
                return;
            }
            if (!selectedModel || selectedModel === 'No models available' || selectedModel === 'Failed to load models') {
                ragStatus.textContent = 'Please select a valid LLM.';
                return;
            }

            ragStatus.textContent = `Thinking with ${selectedModel}...`;
            ragAnswerDiv.textContent = '(Generating response...)';
            ragContextDiv.innerHTML = '';
            visualizeSection.style.display = 'none'; // Hide visualize section on new query
            ttsControls.style.display = 'none'; // Hide TTS controls on new query
            listenButton.style.display = 'inline-block'; // Ensure listen button is visible again
            audioPlayer.style.display = 'none'; // Hide audio player
            audioPlayer.src = ''; // Clear previous audio
            document.getElementById('generated-image-container').innerHTML = ''; // Clear old image
            
            // Remove old attribution if it exists
            const oldAttribution = ragAnswerContainer.querySelector('.attribution');
            if (oldAttribution) {
                oldAttribution.remove();
            }

            try {
                const formData = new FormData();
                formData.append('query', query);
                formData.append('model', selectedModel);

                const response = await fetch('/query/rag', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    ragAnswerDiv.textContent = result.answer;

                    // Add attribution
                    const attributionDiv = document.createElement('div');
                    attributionDiv.className = 'attribution';
                    attributionDiv.textContent = `Answer generated by ${selectedModel} in response to the question: "${query}"`;
                    ragAnswerContainer.appendChild(attributionDiv);
                    
                    // Show the visualize and listen sections
                    visualizeSection.style.display = 'block';
                    ttsControls.style.display = 'flex'; // Use flex for better alignment
                    loadComfyModels(); // Load models for the visualize section
                    loadElevenLabsVoices(); // Load voices for TTS

                    // Display the context that was used
                    if (result.context && result.context.length > 0) {
                        ragContextDiv.innerHTML = result.context.map((chunk, index) => `
                            <div class="context-item">
                                <p class="meta">Context Chunk ${index + 1}</p>
                                <p>${chunk.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>
                            </div>
                        `).join('');
                    } else {
                        ragContextDiv.innerHTML = '<p>No specific context was retrieved to generate this answer.</p>';
                    }
                    ragStatus.textContent = 'Answer received.';
                } else {
                    throw new Error(result.detail || 'Failed to get RAG answer.');
                }
            } catch (error) {
                ragStatus.textContent = `Error: ${error.message}`;
                ragAnswerDiv.textContent = `Failed to get an answer. ${error.message}`;
            }
        });

        // --- Handle Text-to-Speech ---

        async function loadElevenLabsVoices() {
            try {
                const response = await fetch('/api/elevenlabs/voices');
                if (!response.ok) throw new Error('Failed to fetch ElevenLabs voices.');
                
                const data = await response.json();
                voiceSelect.innerHTML = ''; // Clear previous options
                data.voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.voice_id;
                    option.textContent = voice.name;
                    voiceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching ElevenLabs voices:', error);
                voiceSelect.innerHTML = `<option>Error loading voices</option>`;
            }
        }

        listenButton.addEventListener('click', async () => {
            const textToSpeak = ragAnswerDiv.textContent;
            const selectedVoice = voiceSelect.value;
            if (!textToSpeak || !selectedVoice) return;

            listenButton.textContent = 'Generating...';
            listenButton.disabled = true;

            try {
                const formData = new FormData();
                formData.append('text', textToSpeak);
                formData.append('voice_id', selectedVoice);

                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    audioPlayer.play();
                    listenButton.style.display = 'none'; // Hide button, show player
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate audio.');
                }
            } catch (error) {
                ragStatus.textContent = `TTS Error: ${error.message}`;
            } finally {
                listenButton.textContent = 'Listen';
                listenButton.disabled = false;
                // On a new query, the whole tts-controls div is hidden and reset,
                // so we don't need to manually re-show the button here.
            }
        });


        // --- Handle Image Generation ---
        
        async function loadComfyModels() {
            const comfyModelsList = document.getElementById('comfy-models-list');
            const visualizeStatus = document.getElementById('visualize-status');
            try {
                visualizeStatus.textContent = 'Fetching image models...';
                const response = await fetch('/api/comfy/models');
                if (!response.ok) throw new Error('Failed to fetch ComfyUI models.');
                
                const data = await response.json();
                comfyModelsList.innerHTML = '';
                data.models.forEach(modelName => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    comfyModelsList.appendChild(option);
                });
                visualizeStatus.textContent = 'Image models loaded.';
            } catch (error) {
                visualizeStatus.textContent = `Error: ${error.message}`;
            }
        }

        const visualizeForm = document.getElementById('visualize-form');
        visualizeForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const visualizeStatus = document.getElementById('visualize-status');
            const imageContainer = document.getElementById('generated-image-container');
            
            const basePrompt = ragAnswerDiv.textContent;
            const artisticDirection = document.getElementById('artistic-direction-input').value;
            const selectedImageModel = document.getElementById('comfy-model-input').value;
            const selectedLLM = document.getElementById('model-select').value; // Get the selected LLM for prompt generation

            if (!selectedImageModel) {
                visualizeStatus.textContent = 'Please select an image model.';
                return;
            }

            visualizeStatus.textContent = 'Generating new image prompt with AI Art Director...';
            imageContainer.innerHTML = '<p>The AI Art Director is thinking...</p>';

            try {
                // --- Step 1: Generate the new prompt with the AI Art Director ---
                const promptGenFormData = new FormData();
                promptGenFormData.append('base_prompt', basePrompt);
                promptGenFormData.append('artistic_direction', artisticDirection);
                promptGenFormData.append('model', selectedLLM);

                const promptGenResponse = await fetch('/api/generate-image-prompt', {
                    method: 'POST',
                    body: promptGenFormData
                });

                if (!promptGenResponse.ok) {
                    const error = await promptGenResponse.json();
                    throw new Error(`AI Art Director failed: ${error.detail}`);
                }

                const promptGenResult = await promptGenResponse.json();
                const finalPrompt = promptGenResult.new_prompt;

                visualizeStatus.textContent = `Dreaming with ${selectedImageModel}...`;
                imageContainer.innerHTML = `<p>Image generation in progress with new prompt: "<em>${finalPrompt.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</em>"</p>`;

                // --- Step 2: Generate the image with the new prompt ---
                const imageGenFormData = new FormData();
                imageGenFormData.append('prompt', finalPrompt);
                imageGenFormData.append('model', selectedImageModel);

                const imageResponse = await fetch('/api/generate-image', {
                    method: 'POST',
                    body: imageGenFormData
                });

                if (imageResponse.ok) {
                    const imageBlob = await imageResponse.blob();
                    const imageUrl = URL.createObjectURL(imageBlob);
                    imageContainer.innerHTML = `<img id="generated-image" src="${imageUrl}" alt="Generated image based on the AI-enhanced prompt">`;
                    visualizeStatus.textContent = 'Image generated successfully!';
                } else {
                    const error = await imageResponse.json();
                    throw new Error(error.detail || 'Image generation failed.');
                }
            } catch (error) {
                visualizeStatus.textContent = `Error: ${error.message}`;
                imageContainer.innerHTML = `<p style="color:red;">${error.message}</p>`;
            }
        });
    </script>
</body>
</html>

